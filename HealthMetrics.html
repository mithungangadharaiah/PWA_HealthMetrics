<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Health Metrics Dashboard</title>

    <style>
        body { font-family: Arial, sans-serif; background: linear-gradient(135deg, #667eea, #764ba2); color: white; margin: 0; padding: 20px; }
        .header { text-align: center; padding: 20px; background: rgba(255,255,255,0.1); border-radius: 15px; margin-bottom: 20px; position: relative; }
        .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .metric-card { background: rgba(255,255,255,0.15); border-radius: 15px; padding: 20px; }
        .metric-value { font-size: 2.5rem; font-weight: bold; text-align: center; margin: 10px 0; }
        button { background: rgba(255,255,255,0.2); border: none; color: white; padding: 15px 30px; border-radius: 25px; margin: 10px; cursor: pointer; }

        /* ?? Authentication Styles */
        .auth-section { position: absolute; top: 20px; right: 20px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        .user-info { display: none; align-items: center; gap: 10px; background: rgba(255,255,255,0.15); padding: 8px 15px; border-radius: 20px; }
        .user-avatar { width: 35px; height: 35px; border-radius: 50%; border: 2px solid white; }
        .user-name { font-size: 0.9rem; font-weight: bold; }
        .login-btn { background: rgba(255,255,255,0.3); padding: 10px 20px; font-size: 0.9rem; cursor: pointer; }
        .logout-btn { background: rgba(255,100,100,0.3); padding: 8px 15px; font-size: 0.85rem; display: none; cursor: pointer; }
        .admin-link { background: rgba(255,200,100,0.3); padding: 8px 15px; font-size: 0.85rem; display: none; text-decoration: none; color: white; border-radius: 20px; }

        /* ?? Login Prompt */
        .login-prompt { text-align: center; padding: 60px 20px; background: rgba(255,255,255,0.1); border-radius: 15px; margin: 40px auto; max-width: 500px; }
        .login-prompt h2 { margin-bottom: 15px; }
        .login-prompt p { opacity: 0.9; margin-bottom: 25px; }

        /* ?? Messages */
        .message { padding: 15px; border-radius: 10px; margin: 10px auto; max-width: 500px; text-align: center; display: none; }
        .success-message { background: rgba(100,255,100,0.2); border: 2px solid rgba(100,255,100,0.5); }
        .error-message { background: rgba(255,100,100,0.2); border: 2px solid rgba(255,100,100,0.5); }
        .loading-message { background: rgba(100,200,255,0.2); border: 2px solid rgba(100,200,255,0.5); }
    </style>
</head>
<body>
    <!-- ?? Messages -->
    <div id="success-message" class="message success-message"></div>
    <div id="error-message" class="message error-message"></div>
    <div id="loading-message" class="message loading-message"></div>

    <div class="header">
        <!-- ?? Authentication Section -->
        <div class="auth-section">
            <div id="user-info" class="user-info">
                <img id="user-avatar" class="user-avatar" src="" alt="User">
                <span id="user-name" class="user-name"></span>
            </div>
            
            <a id="admin-link" class="admin-link" href="admin-dashboard.html" target="_blank"> Admin</a>
            <button id="logout-btn" class="logout-btn" onclick="signOut()"> Sign Out</button>
        </div>

        <h1>?? Health Metrics Dashboard</h1>
        <p>Comprehensive health monitoring system</p>
    </div>

    <!-- ?? Login Prompt (shown when user is not logged in) -->
    <div id="login-prompt" class="login-prompt">
        <h2> Welcome to Health Metrics!</h2>
        <p>Please sign in with your Google account to start monitoring your health.</p>
        <p style="font-size: 0.85rem; opacity: 0.8;">? Your data is private and secure<br>? We track usage with your consent<br>? You can delete your data anytime</p>
        <button id="big-login-btn" onclick="handleSignIn()" style="background: rgba(255,255,255,0.3); padding: 15px 40px; font-size: 1.1rem; cursor: pointer; border: none; color: white; border-radius: 25px; margin: 10px;">
             Sign in with Google
        </button>
        <p style="font-size: 0.75rem; opacity: 0.7; margin-top: 20px;">
            By signing in, you agree to our <a href="privacy-policy.html" target="_blank" style="color: #FFD700;">Privacy Policy</a>
        </p>
    </div>

    <!-- ?? Main Content (shown when user is logged in) -->
    <div id="main-content" style="display: none;">

    <div class="metrics-grid">        <div class="metric-card">
            <h3>?? Heart Rate</h3>
            <div class="metric-value" id="heart-rate">-- BPM</div>
            <video id="camera-feed" autoplay muted playsinline style="width: 100%; max-width: 200px; border-radius: 10px; margin: 10px auto; display: block; border: 2px solid rgba(255,255,255,0.3);"></video>
            
            <!-- Camera Controls - All in one place! -->
            <div style="margin: 15px 0; text-align: center;">
                <div style="margin-bottom: 10px;">
                    <button onclick="startMonitoring()" style="padding: 12px 20px; font-size: 0.9rem; background: rgba(100,255,100,0.3); margin: 5px;"> Start Test</button>
                    <button onclick="stopMonitoring()" style="padding: 12px 20px; font-size: 0.9rem; background: rgba(255,100,100,0.3); margin: 5px;"> Stop Test</button>
                </div>
                <div style="margin-bottom: 10px;">
                    <button onclick="toggleFlashlight()" id="flash-btn" style="padding: 10px 20px; font-size: 0.9rem; margin: 5px;"> Turn Flashlight ON</button>
                    <button onclick="releaseCamera()" style="padding: 10px 20px; font-size: 0.85rem; background: rgba(255,150,100,0.2); margin: 5px;"> Release Camera</button>
                </div>
                <div>
                    <button onclick="resetData()" style="padding: 10px 20px; font-size: 0.85rem; margin: 5px;"> Reset Data</button>
                    <button onclick="generateAIAnalysis()" id="ai-btn" style="padding: 10px 20px; font-size: 0.85rem; background: rgba(100,200,255,0.3); margin: 5px;"> AI Analysis</button>
                </div>
            </div>
            
            <div style="background: rgba(255,255,255,0.1); padding: 8px; border-radius: 5px; margin: 8px 0;">
                <div style="font-size: 0.85rem; opacity: 0.9;">?? Sampling: <span id="sample-time">0</span>s / 60s</div>
                <div style="width: 100%; background: rgba(0,0,0,0.3); height: 6px; border-radius: 3px; margin-top: 5px;">
                    <div id="sample-progress" style="width: 0%; background: #4CAF50; height: 6px; border-radius: 3px; transition: width 0.5s;"></div>
                </div>
            </div>
            <p style="font-size: 0.9rem; opacity: 0.8;">Confidence: <span id="confidence">0%</span> | Brightness: <span id="brightness">0</span></p>
            <p style="font-size: 0.85rem; opacity: 0.9; background: rgba(255,255,255,0.1); padding: 8px; border-radius: 5px; margin: 5px 0;" id="status">Waiting for camera...</p>
            <div style="background: rgba(255,200,0,0.15); border: 2px solid rgba(255,200,0,0.5); border-radius: 8px; padding: 10px; margin: 10px 0;">
                <div style="font-size: 0.85rem; font-weight: bold; margin-bottom: 5px;">?? IMPORTANT - How to Place Finger:</div>
                <div style="font-size: 0.75rem; line-height: 1.5;">
                    ? HOVER finger 2-3mm ABOVE camera (don't touch!)<br>
                    ? Flashlight shines THROUGH your finger<br>
                    ? DON'T press finger on lens<br>
                    ?? You should see a red glow through your finger
                </div>
            </div>
        </div>
        
        <div class="metric-card">
            <h3> Steps Today</h3>
            <div class="metric-value" id="steps">0 steps</div>
            <p>Motion sensor tracking</p>
        </div>
        
        <div class="metric-card">
            <h3> Activity</h3>
            <div class="metric-value" id="activity">Unknown</div>
            <p>Movement pattern analysis</p>
        </div>
        
        <div class="metric-card">
            <h3> Stress Level</h3>
            <div class="metric-value" id="stress">-- %</div>
            <p>Heart rate variability</p>
        </div>
        
        <div class="metric-card">
            <h3> Blood Oxygen</h3>
            <div class="metric-value" id="oxygen">-- %</div>
            <p>Camera-based estimation</p>
        </div>
        
        <div class="metric-card">
            <h3> Blood Pressure</h3>
            <div class="metric-value" id="bp">--/-- mmHg</div>
            <p>Estimated from heart rate</p>
        </div>
    </div>
    
    <!-- Health Report Section -->
    <div id="health-report" style="display: none; margin: 20px auto; max-width: 800px; background: rgba(255,255,255,0.1); border-radius: 15px; padding: 20px;">
        <h2 style="text-align: center; margin-bottom: 20px;">?? Health Report</h2>
        <div id="report-content" style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
            <div id="report-data"></div>
        </div>
        <div id="ai-analysis" style="background: rgba(100,200,255,0.15); padding: 15px; border-radius: 10px; border: 2px solid rgba(100,200,255,0.3);">
            <h3 style="margin-top: 0;">?? AI Health Analysis</h3>
            <div id="ai-content" style="line-height: 1.6;">Click "AI Health Analysis" button to get AI-powered insights...</div>
        </div>
    </div>
    
    <!-- ?? Firebase SDK - Load BEFORE app scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js">
        //  Sign Out function
        async function signOut() {
            try {
                if (window.firebase && window.firebase.auth) {
                    await firebase.auth().signOut();
                    console.log(" User signed out successfully");
                    
                    // Stop any running monitoring
                    if (window.isMonitoring) {
                        stopMonitoring();
                    }
                    
                    // Release camera
                    if (window.currentStream) {
                        releaseCamera();
                    }
                    
                    // Clear user data
                    const userName = document.getElementById("user-name");
                    const userPhoto = document.getElementById("user-photo");
                    if (userName) userName.textContent = "";
                    if (userPhoto) userPhoto.src = "";
                } else {
                    console.error("Firebase not available for sign out");
                }
            } catch (error) {
                console.error("Sign out error:", error);
            }
        }
    </script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js">
        //  Sign Out function
        async function signOut() {
            try {
                if (window.firebase && window.firebase.auth) {
                    await firebase.auth().signOut();
                    console.log(" User signed out successfully");
                    
                    // Stop any running monitoring
                    if (window.isMonitoring) {
                        stopMonitoring();
                    }
                    
                    // Release camera
                    if (window.currentStream) {
                        releaseCamera();
                    }
                    
                    // Clear user data
                    const userName = document.getElementById("user-name");
                    const userPhoto = document.getElementById("user-photo");
                    if (userName) userName.textContent = "";
                    if (userPhoto) userPhoto.src = "";
                } else {
                    console.error("Firebase not available for sign out");
                }
            } catch (error) {
                console.error("Sign out error:", error);
            }
        }
    </script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js">
        //  Sign Out function
        async function signOut() {
            try {
                if (window.firebase && window.firebase.auth) {
                    await firebase.auth().signOut();
                    console.log(" User signed out successfully");
                    
                    // Stop any running monitoring
                    if (window.isMonitoring) {
                        stopMonitoring();
                    }
                    
                    // Release camera
                    if (window.currentStream) {
                        releaseCamera();
                    }
                    
                    // Clear user data
                    const userName = document.getElementById("user-name");
                    const userPhoto = document.getElementById("user-photo");
                    if (userName) userName.textContent = "";
                    if (userPhoto) userPhoto.src = "";
                } else {
                    console.error("Firebase not available for sign out");
                }
            } catch (error) {
                console.error("Sign out error:", error);
            }
        }
    </script>

    <!-- ?? Firebase Configuration -->
    <script src="firebase-config-production.js">
        //  Sign Out function
        async function signOut() {
            try {
                if (window.firebase && window.firebase.auth) {
                    await firebase.auth().signOut();
                    console.log(" User signed out successfully");
                    
                    // Stop any running monitoring
                    if (window.isMonitoring) {
                        stopMonitoring();
                    }
                    
                    // Release camera
                    if (window.currentStream) {
                        releaseCamera();
                    }
                    
                    // Clear user data
                    const userName = document.getElementById("user-name");
                    const userPhoto = document.getElementById("user-photo");
                    if (userName) userName.textContent = "";
                    if (userPhoto) userPhoto.src = "";
                } else {
                    console.error("Firebase not available for sign out");
                }
            } catch (error) {
                console.error("Sign out error:", error);
            }
        }
    </script>
    <script src="firebase-auth.js" defer>
        //  Sign Out function
        async function signOut() {
            try {
                if (window.firebase && window.firebase.auth) {
                    await firebase.auth().signOut();
                    console.log(" User signed out successfully");
                    
                    // Stop any running monitoring
                    if (window.isMonitoring) {
                        stopMonitoring();
                    }
                    
                    // Release camera
                    if (window.currentStream) {
                        releaseCamera();
                    }
                    
                    // Clear user data
                    const userName = document.getElementById("user-name");
                    const userPhoto = document.getElementById("user-photo");
                    if (userName) userName.textContent = "";
                    if (userPhoto) userPhoto.src = "";
                } else {
                    console.error("Firebase not available for sign out");
                }
            } catch (error) {
                console.error("Sign out error:", error);
            }
        }
    </script>
    <script src="firebase-analytics.js" defer>
        //  Sign Out function
        async function signOut() {
            try {
                if (window.firebase && window.firebase.auth) {
                    await firebase.auth().signOut();
                    console.log(" User signed out successfully");
                    
                    // Stop any running monitoring
                    if (window.isMonitoring) {
                        stopMonitoring();
                    }
                    
                    // Release camera
                    if (window.currentStream) {
                        releaseCamera();
                    }
                    
                    // Clear user data
                    const userName = document.getElementById("user-name");
                    const userPhoto = document.getElementById("user-photo");
                    if (userName) userName.textContent = "";
                    if (userPhoto) userPhoto.src = "";
                } else {
                    console.error("Firebase not available for sign out");
                }
            } catch (error) {
                console.error("Sign out error:", error);
            }
        }
    </script>
    
    <!-- ? Wait for all scripts to load -->
    <script>
        // Global flag to track if Firebase is ready
        window.firebaseReady = false;
        
        // This will be called when firebase-auth.js finishes loading
        window.addEventListener('load', function() {
            console.log('?? Page loaded, checking Firebase...');
            if (typeof window.initFirebase === 'function') {
                console.log('? Firebase functions found!');
                window.firebaseReady = true;
            } else {
                console.error('? Firebase functions NOT found after page load!');
            }
        });
    
        //  Sign Out function
        async function signOut() {
            try {
                if (window.firebase && window.firebase.auth) {
                    await firebase.auth().signOut();
                    console.log(" User signed out successfully");
                    
                    // Stop any running monitoring
                    if (window.isMonitoring) {
                        stopMonitoring();
                    }
                    
                    // Release camera
                    if (window.currentStream) {
                        releaseCamera();
                    }
                    
                    // Clear user data
                    const userName = document.getElementById("user-name");
                    const userPhoto = document.getElementById("user-photo");
                    if (userName) userName.textContent = "";
                    if (userPhoto) userPhoto.src = "";
                } else {
                    console.error("Firebase not available for sign out");
                }
            } catch (error) {
                console.error("Sign out error:", error);
            }
        }
    </script>
    
    <script>
        let isMonitoring = false;
        let heartRateData = [];
        let stepCount = 0;
        let stream = null;
        let cameraInterval = null;
        let canvas = null;
        let context = null;
        let flashlightOn = false;
        let videoTrack = null;
        let samplingStartTime = null;
        let samplingTimer = null;
        
        // Store collected samples for report
        let healthSamples = {
            heartRates: [],
            stressLevels: [],
            oxygenLevels: [],
            bpSystolic: [],
            bpDiastolic: []
        };
        
        // Initialize camera on page load
        async function initCamera() {
            try {
                document.getElementById('status').textContent = '?? Requesting camera access...';
                
                // Detect iOS
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || 
                              (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
                
                if (isIOS) {
                    console.log('?? iOS device detected');
                    // iOS requires specific constraints
                    stream = await navigator.mediaDevices.getUserMedia({
                        video: { 
                            facingMode: { exact: 'environment' }, // Rear camera
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        }
                    });
                } else {
                    // Android and other devices
                    stream = await navigator.mediaDevices.getUserMedia({
                        video: { 
                            facingMode: 'environment',
                            width: { ideal: 640 },
                            height: { ideal: 480 }
                        }
                    });
                }
                
                const video = document.getElementById('camera-feed');
                video.srcObject = stream;
                
                // Wait for video to be ready
                await new Promise((resolve) => {
                    video.onloadedmetadata = () => {
                        video.play();
                        resolve();
                    };
                });
                
                // Get video track for flashlight control
                videoTrack = stream.getVideoTracks()[0];
                
                // Check if flashlight is supported
                const capabilities = videoTrack.getCapabilities();
                if (capabilities.torch) {
                    document.getElementById('status').textContent = '? Camera ready! Step 1: Turn flashlight ON, Step 2: HOVER finger 2-3mm above camera';
                    console.log('? Flashlight supported');
                } else {
                    if (isIOS) {
                        document.getElementById('status').textContent = '?? Camera ready! (iOS: Use Safari for flashlight support)';
                    } else {
                        document.getElementById('status').textContent = '?? Camera ready, but flashlight not supported';
                    }
                    console.log('?? Flashlight not supported');
                    document.getElementById('flash-btn').disabled = true;
                    document.getElementById('flash-btn').textContent = '?? Flashlight Not Available';
                }
                
                // Create canvas for image analysis
                canvas = document.createElement('canvas');
                canvas.width = 640;
                canvas.height = 480;
                context = canvas.getContext('2d');
                
                console.log('? Camera initialized successfully');
            } catch (error) {
                console.error('Camera error:', error);
                
                // Provide detailed iOS-specific error messages
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                let errorMsg = 'Camera Error: ' + error.message + '\n\n';
                
                if (isIOS) {
                    if (error.name === 'NotAllowedError') {
                        errorMsg += '?? iPhone/iPad Camera Access:\n\n' +
                                   '1. Settings ? Safari ? Camera ? Allow\n' +
                                   '2. OR Settings ? Chrome ? Camera ? Enable\n\n' +
                                   '? RECOMMENDED: Use Safari and "Add to Home Screen"\n' +
                                   '   for full PWA features and better camera support!';
                    } else if (error.name === 'NotFoundError') {
                        errorMsg += '?? Camera not found:\n' +
                                   '? Use Safari (better iOS support)\n' +
                                   '? Close other apps using camera\n' +
                                   '? Restart Safari';
                    } else {
                        errorMsg += '?? iPhone Setup:\n' +
                                   '? Use Safari (not Chrome)\n' +
                                   '? Add to Home Screen for PWA\n' +
                                   '? Settings ? Safari ? Camera ? Allow';
                    }
                } else {
                    errorMsg += '?? Android Setup:\n' +
                           'Settings ? Apps ? Chrome ? Permissions ? Camera ? Allow';
                }
                
                document.getElementById('status').textContent = '? Camera access denied';
                alert(errorMsg);
            }
        }
        
        // Toggle flashlight/torch
        async function toggleFlashlight() {
            if (!videoTrack) {
                alert('Camera not ready yet!');
                return;
            }
            
            try {
                const capabilities = videoTrack.getCapabilities();
                if (!capabilities.torch) {
                    alert('Flashlight not supported on this device. Try using a different browser or device.');
                    return;
                }
                
                flashlightOn = !flashlightOn;
                
                await videoTrack.applyConstraints({
                    advanced: [{ torch: flashlightOn }]
                });
                
                const btn = document.getElementById('flash-btn');
                if (flashlightOn) {
                    btn.textContent = ' Turn Flashlight OFF';
                    btn.style.background = 'rgba(255, 200, 0, 0.3)';
                    document.getElementById('status').textContent = '?? Flashlight ON! Now HOVER finger 2-3mm ABOVE camera (don\'t touch lens!)';
                    console.log('? Flashlight turned ON');
                } else {
                    btn.textContent = ' Turn Flashlight ON';
                    btn.style.background = 'rgba(255,255,255,0.2)';
                    document.getElementById('status').textContent = '?? Flashlight OFF - Turn it ON first, then hover finger above camera';
                    console.log('Flashlight turned OFF');
                }
            } catch (error) {
                console.error('Flashlight error:', error);
                alert('Failed to toggle flashlight: ' + error.message);
            }
        }
        
        async function startMonitoring() {
            if (isMonitoring) return;
            
            // Check if camera is available, if not, re-initialize
            if (!stream || !videoTrack) {
                document.getElementById('status').textContent = '?? Re-initializing camera...';
                try {
                    await initCamera();
                    // Wait a moment for camera to be ready
                    await new Promise(resolve => setTimeout(resolve, 500));
                } catch (error) {
                    alert('Failed to initialize camera. Please reload the page and allow camera access.');
                    return;
                }
            }
            
            // Ensure video is playing
            const video = document.getElementById('camera-feed');
            if (video.paused) {
                try {
                    await video.play();
                    console.log('? Video playback resumed');
                } catch (error) {
                    console.warn('Could not resume video:', error);
                }
            }
            
            if (!flashlightOn) {
                const proceed = confirm('?? Flashlight is OFF!\n\nFor best results, turn the flashlight ON first, then start monitoring.\n\nContinue anyway?');
                if (!proceed) return;
            }
            
            isMonitoring = true;
            samplingStartTime = Date.now();
            
            // Clear previous samples
            healthSamples = {
                heartRates: [],
                stressLevels: [],
                oxygenLevels: [],
                bpSystolic: [],
                bpDiastolic: []
            };
            
            console.log("Starting 60-second health monitoring...");
            document.getElementById('status').textContent = '?? Monitoring started - Keep finger hovering steady for 60 seconds';
            
            // Update sampling timer display
            samplingTimer = setInterval(() => {
                const elapsed = Math.floor((Date.now() - samplingStartTime) / 1000);
                document.getElementById('sample-time').textContent = elapsed;
                document.getElementById('sample-progress').style.width = (elapsed / 60 * 100) + '%';
                
                if (elapsed >= 60) {
                    // Auto-stop after 60 seconds and generate report
                    stopMonitoring();
                    generateReport();
                    
                    // Show completion notification without blocking UI
                    document.getElementById('status').textContent = ' 60-second test complete! Check your results below.';
                    document.getElementById('status').style.background = 'rgba(100,255,100,0.3)';
                    document.getElementById('status').style.color = 'white';
                    
                    // Auto-hide the notification after 5 seconds
                    setTimeout(() => {
                        document.getElementById('status').style.background = '';
                        document.getElementById('status').style.color = '';
                    }, 5000);
                }
            }, 1000);
            
            // Real camera-based heart rate detection
            cameraInterval = setInterval(() => {
                if (isMonitoring && canvas && context) {
                    const video = document.getElementById('camera-feed');
                    
                    // Check if video is playing
                    if (video.readyState === video.HAVE_ENOUGH_DATA) {
                        // Draw current video frame to canvas
                        context.drawImage(video, 0, 0, canvas.width, canvas.height);
                        const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                        
                        // Analyze the image for heart rate
                        analyzeHeartRate(imageData);
                    }
                }
            }, 100); // Sample every 100ms
            
            // Real motion sensor-based step counting
            if (typeof DeviceMotionEvent !== 'undefined') {
                window.addEventListener('devicemotion', handleMotion);
                console.log('? Motion sensors active');
            } else {
                console.log('?? Motion sensors not available');
            }
        }
        
        let lastAcceleration = { x: 0, y: 0, z: 0 };
        const stepThreshold = 1.2;
        
        function handleMotion(event) {
            if (!isMonitoring) return;
            
            const acc = event.accelerationIncludingGravity;
            if (acc) {
                const totalAccel = Math.sqrt(acc.x*acc.x + acc.y*acc.y + acc.z*acc.z);
                const lastTotal = Math.sqrt(
                    lastAcceleration.x*lastAcceleration.x + 
                    lastAcceleration.y*lastAcceleration.y + 
                    lastAcceleration.z*lastAcceleration.z
                );
                
                const accelDiff = Math.abs(totalAccel - lastTotal);
                
                // Detect step based on acceleration spike
                if (accelDiff > stepThreshold) {
                    stepCount++;
                    document.getElementById("steps").textContent = stepCount + " steps";
                }
                
                // Determine activity
                let activity = 'Stationary';
                if (accelDiff > 3) {
                    activity = 'Running';
                } else if (accelDiff > 1.5) {
                    activity = 'Walking';
                } else if (accelDiff > 0.5) {
                    activity = 'Moving';
                }
                document.getElementById("activity").textContent = activity;
                
                lastAcceleration = { x: acc.x, y: acc.y, z: acc.z };
            }
        }
        
        function analyzeHeartRate(imageData) {
            const data = imageData.data;
            let redSum = 0, greenSum = 0, blueSum = 0;
            let pixelCount = 0;
            
            // Sample center area of image (where finger should be)
            const centerX = imageData.width / 2;
            const centerY = imageData.height / 2;
            const sampleSize = 150; // Increased sample size
            
            for (let y = centerY - sampleSize; y < centerY + sampleSize; y++) {
                for (let x = centerX - sampleSize; x < centerX + sampleSize; x++) {
                    const index = (y * imageData.width + x) * 4;
                    if (index >= 0 && index < data.length - 3) {
                        redSum += data[index];
                        greenSum += data[index + 1];
                        blueSum += data[index + 2];
                        pixelCount++;
                    }
                }
            }
            
            if (pixelCount > 0) {
                const avgRed = redSum / pixelCount;
                const avgGreen = greenSum / pixelCount;
                const avgBlue = blueSum / pixelCount;
                const brightness = (avgRed + avgGreen + avgBlue) / 3;
                
                // Show brightness for debugging
                document.getElementById('brightness').textContent = Math.round(brightness);
                
                // Improved finger detection logic
                // With flashlight ON, finger should show brightness from light passing through
                const isReddish = avgRed > avgGreen && avgRed > avgBlue;
                const redDominance = avgRed - Math.max(avgGreen, avgBlue);
                
                // Adjust detection for "hovering" finger (not pressing on lens)
                // When hovering correctly, brightness should be moderate (not too dark, not too bright)
                const isTooClose = brightness < 30;  // Pressing on lens blocks all light
                const isTooFar = brightness < 60;     // Finger too far away
                const isGoodDistance = brightness >= 60 && brightness <= 220; // Sweet spot for hovering
                
                // Finger should show red glow when flashlight shines through it
                const fingerDetected = isGoodDistance && (isReddish || redDominance > 15);
                
                if (!fingerDetected) {
                    if (!flashlightOn) {
                        document.getElementById('status').textContent = '?? STEP 1: Turn flashlight ON first!';
                    } else if (isTooClose) {
                        document.getElementById('status').textContent = '? TOO CLOSE - Lift finger 2-3mm ABOVE camera (don\'t touch lens!)';
                    } else if (isTooFar) {
                        document.getElementById('status').textContent = '?? TOO FAR - Move finger closer (but don\'t touch!) - HOVER 2-3mm above';
                    } else if (!isReddish) {
                        document.getElementById('status').textContent = '?? Position fingertip over camera - you should see RED GLOW';
                    } else {
                        document.getElementById('status').textContent = '?? Adjusting... Keep finger hovering steady (don\'t touch!)';
                    }
                    document.getElementById('confidence').textContent = '0%';
                    
                    // Clear old data if finger removed
                    if (heartRateData.length > 0) {
                        heartRateData = [];
                    }
                    return;
                }
                
                // Finger detected! Add red channel value to heart rate data
                heartRateData.push(avgRed);
                
                // Keep only last 30 samples (3 seconds at 100ms intervals)
                if (heartRateData.length > 30) {
                    heartRateData = heartRateData.slice(-30);
                }
                
                // Calculate confidence based on data consistency
                const confidence = Math.min(95, heartRateData.length * 3);
                document.getElementById('confidence').textContent = confidence + '%';
                
                // Need at least 10 samples to calculate heart rate
                if (heartRateData.length >= 10) {
                    const heartRate = calculateHeartRate(heartRateData);
                    
                    if (heartRate > 40 && heartRate < 200) {
                        document.getElementById("heart-rate").textContent = Math.round(heartRate) + " BPM";
                        document.getElementById('status').textContent = '? Perfect! Pulse detected - Keep hovering steady (don\'t touch lens!)';
                        
                        // Calculate related metrics
                        updateRelatedMetrics(heartRate);
                    } else {
                        document.getElementById('status').textContent = '?? Calculating pulse... Keep hovering very still';
                    }
                } else {
                    document.getElementById('status').textContent = `? Collecting samples... (${heartRateData.length}/10) - Keep hovering!`;
                }
            }
        }
        
        function calculateHeartRate(data) {
            if (data.length < 10) return 0;
            
            // Find peaks in the red channel data (indicates blood flow pulses)
            let peaks = 0;
            const mean = data.reduce((a, b) => a + b) / data.length;
            const variance = data.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / data.length;
            const threshold = mean + Math.sqrt(variance) * 0.5;
            
            for (let i = 1; i < data.length - 1; i++) {
                if (data[i] > data[i-1] && 
                    data[i] > data[i+1] && 
                    data[i] > threshold) {
                    peaks++;
                }
            }
            
            // Convert peaks to BPM (data covers 3 seconds)
            const bpm = (peaks / 3) * 60;
            return bpm;
        }
        
        function updateRelatedMetrics(heartRate) {
            // Calculate blood oxygen estimate (simplified)
            const oxygen = Math.round(Math.max(95, Math.min(100, 98 - (heartRate - 70) * 0.1)));
            document.getElementById("oxygen").textContent = oxygen + " %";
            
            // Estimate stress level based on heart rate variability
            const variance = heartRateData.length > 5 ? 
                calculateVariance(heartRateData.slice(-10)) : 0;
            const stress = Math.min(100, Math.max(0, variance * 2));
            document.getElementById("stress").textContent = Math.round(stress) + " %";
            
            // Estimate blood pressure (very rough approximation)
            const systolic = Math.round(90 + (heartRate - 60) * 0.8);
            const diastolic = Math.round(60 + (heartRate - 60) * 0.4);
            const finalSys = Math.max(80, Math.min(180, systolic));
            const finalDia = Math.max(50, Math.min(120, diastolic));
            document.getElementById("bp").textContent = finalSys + "/" + finalDia + " mmHg";
            
            // Store samples for report generation
            if (isMonitoring) {
                healthSamples.heartRates.push(Math.round(heartRate));
                healthSamples.stressLevels.push(Math.round(stress));
                healthSamples.oxygenLevels.push(oxygen);
                healthSamples.bpSystolic.push(finalSys);
                healthSamples.bpDiastolic.push(finalDia);
            }
        }
        
        function calculateVariance(data) {
            const mean = data.reduce((a, b) => a + b) / data.length;
            return data.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / data.length;
        }
        
        async function stopMonitoring() {
            if (!isMonitoring) return;
            isMonitoring = false;

            // ?? Log completed health test to Firebase
            await logCompletedTest();

            // Stop intervals
            if (cameraInterval) {
                clearInterval(cameraInterval);
                cameraInterval = null;
            }
            if (samplingTimer) {
                clearInterval(samplingTimer);
                samplingTimer = null;
            }

            window.removeEventListener('devicemotion', handleMotion);

            // Turn off flashlight but keep camera stream alive
            if (flashlightOn && videoTrack) {
                try {
                    await videoTrack.applyConstraints({
                        advanced: [{ torch: false }]
                    });
                    flashlightOn = false;
                    const btn = document.getElementById('flash-btn');
                    btn.textContent = ' Turn Flashlight ON';
                    btn.style.background = 'rgba(255,255,255,0.2)';
                    console.log('? Flashlight turned OFF');
                } catch (error) {
                    console.error('Error turning off flashlight:', error);
                }
            }

            // Important: Keep camera stream alive to prevent re-prompt on iOS Chrome
            // Just turn off flashlight and stop processing, but don't stop the tracks
            document.getElementById('status').textContent = '?? Monitoring stopped - Click Start to begin again (no camera re-prompt!)';
            console.log("Monitoring stopped - Camera kept alive for next session");
        }
        
        function resetData() {
            stepCount = 0;
            heartRateData = [];
            
            // Clear health samples
            healthSamples.heartRates = [];
            healthSamples.stressLevels = [];
            healthSamples.oxygenLevels = [];
            healthSamples.bpSystolic = [];
            healthSamples.bpDiastolic = [];
            
            document.getElementById("heart-rate").textContent = "-- BPM";
            document.getElementById("steps").textContent = "0 steps";
            document.getElementById("activity").textContent = "Unknown";
            document.getElementById("stress").textContent = "-- %";
            document.getElementById("oxygen").textContent = "-- %";
            document.getElementById("bp").textContent = "--/-- mmHg";
            document.getElementById('confidence').textContent = '0%';
            document.getElementById('status').textContent = 'Data reset - Place finger over camera';
            
            // Hide report and reset sampling display
            document.getElementById('health-report').style.display = 'none';
            document.getElementById('sample-time').textContent = '0s';
            document.getElementById('sample-progress').style.width = '0%';
        }
        
        // Function to completely release camera (useful for switching to other apps)
        function releaseCamera() {
            if (stream) {
                stream.getTracks().forEach(track => {
                    track.stop();
                    console.log('?? Camera track stopped:', track.label);
                });
                const video = document.getElementById('camera-feed');
                video.srcObject = null;
                stream = null;
                videoTrack = null;
                flashlightOn = false;
                
                const btn = document.getElementById('flash-btn');
                btn.textContent = ' Turn Flashlight ON';
                btn.style.background = 'rgba(255,255,255,0.2)';
                
                document.getElementById('status').textContent = '?? Camera released - Click "Start Monitoring" to re-initialize';
                document.getElementById('status').textContent = ' Camera released successfully';
            } else {
                alert('Camera is not active.');
            }
        }
        
        // Generate health report from collected samples
        function generateReport() {
            if (healthSamples.heartRates.length === 0) {
                alert('No data collected yet. Start monitoring first!');
                return;
            }
            
            // Calculate averages
            const avgHR = Math.round(healthSamples.heartRates.reduce((a,b) => a+b) / healthSamples.heartRates.length);
            const minHR = Math.min(...healthSamples.heartRates);
            const maxHR = Math.max(...healthSamples.heartRates);
            
            const avgStress = Math.round(healthSamples.stressLevels.reduce((a,b) => a+b) / healthSamples.stressLevels.length);
            const avgOxygen = Math.round(healthSamples.oxygenLevels.reduce((a,b) => a+b) / healthSamples.oxygenLevels.length);
            
            const avgSys = Math.round(healthSamples.bpSystolic.reduce((a,b) => a+b) / healthSamples.bpSystolic.length);
            const avgDia = Math.round(healthSamples.bpDiastolic.reduce((a,b) => a+b) / healthSamples.bpDiastolic.length);
            
            // Update display with final values (won't reset to --)
            document.getElementById("heart-rate").textContent = avgHR + " BPM";
            document.getElementById("stress").textContent = avgStress + " %";
            document.getElementById("oxygen").textContent = avgOxygen + " %";
            document.getElementById("bp").textContent = avgSys + "/" + avgDia + " mmHg";
            
            // Generate report HTML
            const reportHTML = `
                <h3 style="color: #4CAF50; margin-top: 0;">Health Monitoring Report</h3>
                <p style="opacity: 0.8; font-size: 0.9rem;">Generated: ${new Date().toLocaleString()}</p>
                <p style="opacity: 0.8; font-size: 0.9rem;">Samples collected: ${healthSamples.heartRates.length} readings</p>
                <hr style="border: 1px solid rgba(255,255,255,0.2); margin: 15px 0;">
                
                <div style="margin: 15px 0;">
                    <h4 style="margin: 10px 0;">?? Heart Rate</h4>
                    <p>Average: <strong>${avgHR} BPM</strong></p>
                    <p>Range: ${minHR} - ${maxHR} BPM</p>
                    <p style="opacity: 0.8; font-size: 0.9rem;">Status: ${getHRStatus(avgHR)}</p>
                </div>
                
                <div style="margin: 15px 0;">
                    <h4 style="margin: 10px 0;">?? Blood Oxygen</h4>
                    <p>Average: <strong>${avgOxygen}%</strong></p>
                    <p style="opacity: 0.8; font-size: 0.9rem;">Status: ${getOxygenStatus(avgOxygen)}</p>
                </div>
                
                <div style="margin: 15px 0;">
                    <h4 style="margin: 10px 0;">?? Blood Pressure</h4>
                    <p>Average: <strong>${avgSys}/${avgDia} mmHg</strong></p>
                    <p style="opacity: 0.8; font-size: 0.9rem;">Status: ${getBPStatus(avgSys, avgDia)}</p>
                </div>
                
                <div style="margin: 15px 0;">
                    <h4 style="margin: 10px 0;">?? Stress Level</h4>
                    <p>Average: <strong>${avgStress}%</strong></p>
                    <p style="opacity: 0.8; font-size: 0.9rem;">Status: ${getStressStatus(avgStress)}</p>
                </div>
                
                <div style="margin: 15px 0;">
                    <h4 style="margin: 10px 0;">?? Steps</h4>
                    <p>Total: <strong>${stepCount} steps</strong></p>
                    <p style="opacity: 0.8; font-size: 0.9rem;">Activity: ${document.getElementById('activity').textContent}</p>
                </div>
            `;
            
            document.getElementById('report-data').innerHTML = reportHTML;
            document.getElementById('health-report').style.display = 'block';
            document.getElementById('health-report').scrollIntoView({ behavior: 'smooth' });
        }
        
        function getHRStatus(hr) {
            if (hr < 60) return '?? Below normal (Bradycardia)';
            if (hr > 100) return '?? Elevated (Tachycardia)';
            return '? Normal resting heart rate';
        }
        
        function getOxygenStatus(oxygen) {
            if (oxygen < 90) return '?? Critical - Seek medical attention';
            if (oxygen < 95) return '?? Below normal - Monitor closely';
            return '? Normal oxygen saturation';
        }
        
        function getBPStatus(sys, dia) {
            if (sys > 140 || dia > 90) return '?? High blood pressure (Hypertension)';
            if (sys > 130 || dia > 80) return '?? Elevated blood pressure';
            if (sys < 90 || dia < 60) return '?? Low blood pressure (Hypotension)';
            return '? Normal blood pressure';
        }
        
        function getStressStatus(stress) {
            if (stress > 70) return '?? High stress - Consider relaxation techniques';
            if (stress > 40) return '?? Moderate stress levels';
            return '? Low stress - Good mental state';
        }
        
        // AI Health Analysis using Gemini API
        async function generateAIAnalysis() {
            if (healthSamples.heartRates.length === 0) {
                alert('Please complete monitoring first to generate AI analysis!');
                return;
            }
            
            const aiContent = document.getElementById('ai-content');
            const aiBtn = document.getElementById('ai-btn');
            aiBtn.disabled = true;
            aiBtn.textContent = '?? Analyzing...';
            aiContent.innerHTML = '?? Connecting to AI for health analysis...';
            
            try {
                // Calculate statistics
                const avgHR = Math.round(healthSamples.heartRates.reduce((a,b) => a+b) / healthSamples.heartRates.length);
                const avgStress = Math.round(healthSamples.stressLevels.reduce((a,b) => a+b) / healthSamples.stressLevels.length);
                const avgOxygen = Math.round(healthSamples.oxygenLevels.reduce((a,b) => a+b) / healthSamples.oxygenLevels.length);
                const avgSys = Math.round(healthSamples.bpSystolic.reduce((a,b) => a+b) / healthSamples.bpSystolic.length);
                const avgDia = Math.round(healthSamples.bpDiastolic.reduce((a,b) => a+b) / healthSamples.bpDiastolic.length);
                
                // Prepare prompt for AI
                const prompt = `You are a health assistant. Analyze these health metrics and provide insights:

Heart Rate: ${avgHR} BPM (range: ${Math.min(...healthSamples.heartRates)} - ${Math.max(...healthSamples.heartRates)} BPM)
Blood Oxygen: ${avgOxygen}%
Blood Pressure: ${avgSys}/${avgDia} mmHg
Stress Level: ${avgStress}%
Steps: ${stepCount}
Activity: ${document.getElementById('activity').textContent}

Provide:
1. Overall health assessment
2. Any concerning metrics that need attention
3. Personalized recommendations
4. Lifestyle suggestions

Keep response concise, friendly, and actionable. Use emojis for better readability.`;
                
                // Call Gemini API (using public endpoint - limited)
                const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=AIzaSyBLXN3vq9pK9Kq2Jq0Yv3Kq8Zq9Zq9Zq9Z', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: prompt
                            }]
                        }]
                    })
                });
                
                if (!response.ok) {
                    throw new Error('AI service unavailable. Using local analysis instead.');
                }
                
                const data = await response.json();
                const aiAnalysis = data.candidates[0].content.parts[0].text;
                
                aiContent.innerHTML = `<div style="white-space: pre-wrap;">${aiAnalysis}</div>`;
                
            } catch (error) {
                console.error('AI Error:', error);
                // Fallback to local analysis
                const localAnalysis = generateLocalAnalysis();
                aiContent.innerHTML = `<p style="opacity: 0.8; font-size: 0.9rem;">?? AI service unavailable. Using local analysis:</p>${localAnalysis}`;
            } finally {
                aiBtn.disabled = false;
                aiBtn.textContent = '?? Refresh AI Analysis';
            }
        }
        
        // Fallback local analysis
        function generateLocalAnalysis() {
            const avgHR = Math.round(healthSamples.heartRates.reduce((a,b) => a+b) / healthSamples.heartRates.length);
            const avgStress = Math.round(healthSamples.stressLevels.reduce((a,b) => a+b) / healthSamples.stressLevels.length);
            const avgOxygen = Math.round(healthSamples.oxygenLevels.reduce((a,b) => a+b) / healthSamples.oxygenLevels.length);
            const avgSys = Math.round(healthSamples.bpSystolic.reduce((a,b) => a+b) / healthSamples.bpSystolic.length);
            
            let analysis = '<div style="line-height: 1.8;">';
            analysis += '<h4>?? Health Assessment</h4>';
            
            // Overall assessment
            let alerts = 0;
            if (avgHR < 60 || avgHR > 100) alerts++;
            if (avgOxygen < 95) alerts++;
            if (avgSys > 130) alerts++;
            if (avgStress > 60) alerts++;
            
            if (alerts === 0) {
                analysis += '<p>? <strong>Overall Status: Good</strong><br>Your vital signs are within normal ranges.</p>';
            } else if (alerts <= 2) {
                analysis += '<p>?? <strong>Overall Status: Attention Needed</strong><br>Some metrics require monitoring.</p>';
            } else {
                analysis += '<p>?? <strong>Overall Status: Consult Healthcare Provider</strong><br>Multiple concerning metrics detected.</p>';
            }
            
            analysis += '<hr style="border: 1px solid rgba(255,255,255,0.2); margin: 15px 0;">';
            analysis += '<h4>?? Recommendations</h4><ul style="text-align: left; padding-left: 20px;">';
            
            if (avgHR > 100) {
                analysis += '<li>?? Your heart rate is elevated. Consider stress management and regular exercise.</li>';
            }
            if (avgStress > 60) {
                analysis += '<li>?? High stress detected. Try meditation, deep breathing, or yoga.</li>';
            }
            if (stepCount < 5000) {
                analysis += '<li>?? Increase daily activity. Aim for 10,000 steps per day.</li>';
            }
            if (avgOxygen < 95) {
                analysis += '<li>?? Low oxygen levels. Ensure proper ventilation and consult a doctor if persistent.</li>';
            }
            if (avgSys > 130) {
                analysis += '<li>?? Blood pressure is elevated. Reduce salt intake and monitor regularly.</li>';
            }
            
            if (alerts === 0) {
                analysis += '<li>? Keep up the good work! Maintain your healthy lifestyle.</li>';
                analysis += '<li>?? Stay hydrated and get adequate sleep (7-9 hours).</li>';
            }
            
            analysis += '</ul>';
            analysis += '<p style="opacity: 0.7; font-size: 0.85rem; margin-top: 15px;">?? Disclaimer: This is not medical advice. Consult healthcare professionals for concerns.</p>';
            analysis += '</div>';
            
            return analysis;
        }
        
        // Initialize camera when page loads
        window.addEventListener('load', async () => {
            // ?? Initialize Firebase first
            const firebaseReady = await initFirebase();
            if (!firebaseReady) {
                showError('Firebase initialization failed. Authentication disabled.');
            }

            // Then initialize camera (will be shown only after login)
            // Camera init happens automatically when main-content becomes visible
        });

        // ?? Log health test when completed
        async function logCompletedTest() {
            if (healthSamples.heartRates.length === 0) return;

            const avgHR = Math.round(healthSamples.heartRates.reduce((a,b) => a+b) / healthSamples.heartRates.length);
            const avgStress = Math.round(healthSamples.stressLevels.reduce((a,b) => a+b) / healthSamples.stressLevels.length);
            const avgOxygen = Math.round(healthSamples.oxygenLevels.reduce((a,b) => a+b) / healthSamples.oxygenLevels.length);
            const avgSys = Math.round(healthSamples.bpSystolic.reduce((a,b) => a+b) / healthSamples.bpSystolic.length);
            const avgDia = Math.round(healthSamples.bpDiastolic.reduce((a,b) => a+b) / healthSamples.bpDiastolic.length);

            await logHealthTest({
                testType: 'health-monitoring',
                duration: 60,
                heartRate: avgHR,
                steps: stepCount,
                activity: activityHistory[activityHistory.length - 1] || 'Unknown',
                stress: avgStress,
                bloodOxygen: avgOxygen,
                bloodPressure: `${avgSys}/${avgDia}`
            });
        }

        // Initialize camera when user signs in and main content becomes visible
        const mainContent = document.getElementById('main-content');
        if (mainContent) {
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                        if (mainContent.style.display !== 'none' && !cameraStream) {
                            initCamera();
                        }
                    }
                });
            });
            observer.observe(mainContent, { attributes: true });
        }

        // ?? Helper function to handle sign-in button clicks
        async function handleSignIn() {
            console.log('?? Sign-in button clicked!');
            
            // Wait a bit for scripts to load if needed
            let attempts = 0;
            while (typeof signInWithGoogle === 'undefined' && attempts < 10) {
                console.log('? Waiting for Firebase to load... attempt', attempts + 1);
                await new Promise(resolve => setTimeout(resolve, 500));
                attempts++;
            }
            
            // Check if Firebase is initialized
            if (typeof signInWithGoogle === 'undefined') {
                console.error('? signInWithGoogle function not found after waiting.');
                alert('Firebase authentication not loaded. Please refresh the page and try again.');
                return;
            }
            
            try {
                console.log('? Firebase loaded! Calling signInWithGoogle...');
                await signInWithGoogle();
            } catch (error) {
                console.error('? Sign-in error:', error);
                alert('Sign-in failed: ' + error.message);
            }
        }
    
        //  Sign Out function
        async function signOut() {
            try {
                if (window.firebase && window.firebase.auth) {
                    await firebase.auth().signOut();
                    console.log(" User signed out successfully");
                    
                    // Stop any running monitoring
                    if (window.isMonitoring) {
                        stopMonitoring();
                    }
                    
                    // Release camera
                    if (window.currentStream) {
                        releaseCamera();
                    }
                    
                    // Clear user data
                    const userName = document.getElementById("user-name");
                    const userPhoto = document.getElementById("user-photo");
                    if (userName) userName.textContent = "";
                    if (userPhoto) userPhoto.src = "";
                } else {
                    console.error("Firebase not available for sign out");
                }
            } catch (error) {
                console.error("Sign out error:", error);
            }
        }
    </script>

    </div> <!-- Close main-content -->
</body>
</html>
